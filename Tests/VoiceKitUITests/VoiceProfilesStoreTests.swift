//
//  VoiceProfilesStoreTests.swift
//  VoiceKitUITests
//
//  Generated by GPT-5 (OpenAI) â€” collaborator: rdoggett
//  date: 09-13-2025
//

import XCTest
import VoiceKitCore
import VoiceKitUI

@MainActor
final class VoiceProfilesStoreTests: XCTestCase {

    func testSaveAndLoadProfilesAndFlags() {
        let filename = "voices-\(UUID().uuidString).json"
        let store1 = VoiceProfilesStore(filename: filename)

        let info = TTSVoiceInfo(id: "v.test", name: "Test Voice", language: "en-US")
        var profile = store1.profile(for: info)
        profile.displayName = "Custom Name"
        profile.rate = 0.7
        profile.pitch = 1.25
        profile.volume = 0.8
        store1.setProfile(profile)

        store1.defaultVoiceID = info.id
        store1.toggleActive(info.id)
        store1.setHidden(info.id, true)
        store1.master = TTSMasterControl(volume: 1.2, pitchVariation: 0.01, rateVariation: 0.02)
        store1.save()

        // Load into a new store from the same file
        let store2 = VoiceProfilesStore(filename: filename)
        XCTAssertEqual(store2.defaultVoiceID, info.id)
        XCTAssertTrue(store2.isActive(info.id))
        XCTAssertTrue(store2.isHidden(info.id))

        guard let p2 = store2.profilesByID[info.id] else {
            return XCTFail("Missing profile after reload")
        }
        XCTAssertEqual(p2.displayName, "Custom Name")
        XCTAssertEqual(p2.rate, 0.7 as Float, accuracy: 0.0001 as Float)
        XCTAssertEqual(p2.pitch, 1.25 as Float, accuracy: 0.0001 as Float)
        XCTAssertEqual(p2.volume, 0.8 as Float, accuracy: 0.0001 as Float)

        XCTAssertEqual(store2.master.volume, 1.2 as Float, accuracy: 0.0001 as Float)
        XCTAssertEqual(store2.master.pitchVariation, 0.01 as Float, accuracy: 0.000001 as Float)
        XCTAssertEqual(store2.master.rateVariation, 0.02 as Float, accuracy: 0.000001 as Float)
    }
}
