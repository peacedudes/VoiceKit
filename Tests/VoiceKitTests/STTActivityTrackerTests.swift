//
//  STTActivityTrackerTests.swift
//  VoiceKit
//
//  Deterministic tests for the STTActivityTracker used by the live
//  listen pipeline to decide when the user has gone quiet.
//
//  Generated by GPT-5 (OpenAI) - collaborator: rdoggett
//  date: 12-03-2025
//

import XCTest
@testable import VoiceKit

internal final class STTActivityTrackerTests: XCTestCase {

    func testLastLoudRemainsNilForQuietBuffers() async {
        let tracker = STTActivityTracker()

        // Very quiet observations should not be considered "speech" and
        // therefore should not move lastLoud() away from nil.
        await tracker.observe(db: -70, at: 1.0)
        await tracker.observe(db: -68, at: 2.0)

        let last = await tracker.lastLoud()
        XCTAssertNil(last, "Expected no loud activity for very quiet buffers")
    }

    func testSpikeAboveMarginMarksLastLoud() async {
        let tracker = STTActivityTracker()

        // Seed baseline around -60 dB with early observations.
        await tracker.observe(db: -60, at: 0.5)
        await tracker.observe(db: -58, at: 1.0)

        // A strong spike should be well above baseline+margin and mark loud.
        await tracker.observe(db: 0, at: 3.0)

        let last = await tracker.lastLoud()
        XCTAssertNotNil(last, "Expected a loud spike to set lastLoud")
        if let last {
            XCTAssertEqual(
                last,
                3.0,
                accuracy: 0.0001,
                "Expected loud spike at t=3.0 to be recorded as lastLoud"
            )
        }
    }

    func testLastLoudMovesForwardOnlyForLaterLoudEvents() async {
        let tracker = STTActivityTracker()

        // First loud event after a bit of baseline.
        await tracker.observe(db: -62, at: 0.5)
        await tracker.observe(db: -60, at: 1.0)
        await tracker.observe(db: 5, at: 2.0)   // spike 1
        let first = await tracker.lastLoud()

        // Later loud event should move the timestamp forward, not backward.
        await tracker.observe(db: 8, at: 4.0)   // spike 2
        let second = await tracker.lastLoud()

        XCTAssertNotNil(first)
        XCTAssertNotNil(second)
        if let first, let second {
            XCTAssertLessThan(
                first,
                second,
                "lastLoud should move forward in time for later loud events"
            )
        }
    }

    func testResetClearsLastLoudAndBaseline() async {
        let tracker = STTActivityTracker()

        // Establish a baseline then a clearly loud spike so lastLoud is set.
        await tracker.observe(db: -60, at: 0.5)
        await tracker.observe(db: -58, at: 1.0)
        await tracker.observe(db: 0, at: 2.0)

        let beforeReset = await tracker.lastLoud()
        XCTAssertNotNil(
            beforeReset,
            "Expected lastLoud to be non-nil before reset after loud spike"
        )

        await tracker.reset(now: nil)
        let afterReset = await tracker.lastLoud()
        XCTAssertNil(
            afterReset,
            "reset(now:) should clear lastLoud"
        )
    }
}
